# Docker Compose for Home Server deployment
# Routes: download.khoadangbui.online/api/* → api:3068 | /* → frontend:3000
# Requires: coolify network (external), NVIDIA Container Toolkit

services:
  gpu-worker:
    build:
      context: .
      dockerfile: docker/Dockerfile.homeserver
    container_name: downloadtool-gpu-worker
    environment:
      - GPU_WORKER_BIND=0.0.0.0:50051
      - GPU_WORKER_MAX_JOBS=4
      - CUDA_DEVICE_ID=0
      - RUST_LOG=info
    volumes:
      - gpu-worker-data:/app/data
    restart: unless-stopped
    networks:
      - coolify
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]

  api:
    build:
      context: .
      dockerfile: docker/Dockerfile.vps
    container_name: downloadtool-api
    environment:
      - PORT=3068
      - GPU_WORKER_ADDR=downloadtool-gpu-worker:50051
      - GPU_ENABLED=true
      - RUST_LOG=info
    volumes:
      - api-data:/app/data
    restart: unless-stopped
    depends_on:
      - gpu-worker
    networks:
      - coolify

  frontend:
    build:
      context: .
      dockerfile: docker/Dockerfile.frontend
    container_name: downloadtool-frontend
    environment:
      - PORT=3000
      - HOST=0.0.0.0
      - ORIGIN=https://download.khoadangbui.online
    restart: unless-stopped
    depends_on:
      - api
    networks:
      - coolify

volumes:
  gpu-worker-data:
  api-data:

networks:
  coolify:
    external: true
