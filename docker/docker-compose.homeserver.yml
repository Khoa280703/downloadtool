services:
  gpu-worker:
    build:
      context: .
      dockerfile: docker/Dockerfile.homeserver
    container_name: downloadtool-gpu-worker
    environment:
      - GPU_WORKER_BIND=0.0.0.0:50051
      - GPU_WORKER_MAX_JOBS=4
      - CUDA_DEVICE_ID=0
      - RUST_LOG=info
    volumes:
      - gpu-worker-data:/app/data
    restart: unless-stopped
    networks:
      - coolify
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]

  api:
    build:
      context: .
      dockerfile: docker/Dockerfile.vps
    container_name: downloadtool-api
    environment:
      - PORT=3068
      - GPU_WORKER_ADDR=http://downloadtool-gpu-worker:50051
      - GPU_ENABLED=true
      - RUST_LOG=info
    expose:
      - "3068"
    volumes:
      - api-data:/app/data
    restart: unless-stopped
    depends_on:
      - gpu-worker
    networks:
      - coolify
    labels:
      - "traefik.http.routers.http-0-o8kccgkgwsockoocow8sg88s-api.service=http-0-o8kccgkgwsockoocow8sg88s-api"
      - "traefik.http.services.http-0-o8kccgkgwsockoocow8sg88s-api.loadbalancer.server.port=3068"

  frontend:
    build:
      context: .
      dockerfile: docker/Dockerfile.frontend
    container_name: downloadtool-frontend
    environment:
      - NODE_ENV=production
      - PORT=3000
      - HOST=0.0.0.0
      - ORIGIN=https://download.khoadangbui.online
      - VITE_API_URL=https://api-download.khoadangbui.online
    expose:
      - "3000"
    restart: unless-stopped
    depends_on:
      - api
    networks:
      - coolify
    labels:
      - "traefik.http.routers.http-0-o8kccgkgwsockoocow8sg88s-frontend.service=http-0-o8kccgkgwsockoocow8sg88s-frontend"
      - "traefik.http.services.http-0-o8kccgkgwsockoocow8sg88s-frontend.loadbalancer.server.port=3000"

volumes:
  gpu-worker-data:
  api-data:

networks:
  coolify:
    external: true